% =========================================================================
% Script: Tobacco Leaf Adaxial/Abaxial Surface Analysis
% Description: 
%   This script performs unsupervised segmentation of stacked tobacco leaves 
%   to distinguish between Adaxial (upper) and Abaxial (lower) surfaces 
%   based on HSV color space analysis and texture filtering.
%
% Requirements: MATLAB R2022b or later, Image Processing Toolbox
% =========================================================================

tic;
clc;
clear;
close all;
warning off;

%% 1. Image Loading and HSV Conversion
% NOTE: Replace the filename below with your specific image path
imgPath = 'sample_image.jpg'; 
img = imread(imgPath);

% Convert RGB to HSV color space
hsvImg = rgb2hsv(im2double(img));  
vChannel = hsvImg(:,:,3);          % Value channel (Brightness)
sChannel = hsvImg(:,:,2);          % Saturation channel

%% 2. Initial Leaf Segmentation
% Thresholding based on Value channel to separate leaf from background
binaryMask = vChannel > 0.2;
binaryMask = imfill(binaryMask, 'holes');
binaryMask = bwareaopen(binaryMask, 500); % Remove small artifacts

% Shadow Detection
% Identify dark regions caused by overlapping shadows
shadowMask = vChannel < 0.3;
shadowMask = bwareaopen(shadowMask, 100);

% Texture Analysis (Wrinkle Detection)
% Calculate local standard deviation to identify complex textures
localStd = stdfilt(vChannel, true(5));
stdThreshold = graythresh(localStd) * 1.5;
wrinkleMask = localStd > stdThreshold;
wrinkleMask = imdilate(wrinkleMask, strel('disk', 3));  
wrinkleMask = bwareaopen(wrinkleMask, 200);

% Stem/Vein Detection
% Stems are typically low saturation and low brightness
stemMask = (vChannel < 0.3) & (sChannel < 0.4);
stemMask = bwareaopen(stemMask, 200);

% Final Pre-processing Mask
% Exclude shadows, heavy wrinkles, and stems from the region of interest
finalMask = binaryMask & ~shadowMask & ~wrinkleMask & ~stemMask;

%% 3. Adaxial/Abaxial Surface Segmentation
% Mask the channels
vMasked = vChannel .* finalMask;
sMasked = sChannel .* finalMask;

% Dynamic Weight Calculation
% Calculate variance to determine the information contribution of each channel
vVar = var(vMasked(finalMask));
sVar = var(sMasked(finalMask));
totalVar = vVar + sVar;

vWeight = vVar / totalVar;
sWeight = sVar / totalVar;

% Feature Fusion and Scoring
% Calculate combined score based on weighted Saturation and Value
combinedScore = vWeight * vMasked + sWeight * sMasked;

% Determine Segmentation Threshold (Adaptive Median)
threshold = median(combinedScore(finalMask));

% Generate Surface Masks
% Lower score typically corresponds to Abaxial (Lower) surface due to light scattering
abaxialMask = finalMask & (combinedScore <= threshold);
% Higher score typically corresponds to Adaxial (Upper) surface
adaxialMask = finalMask & ~abaxialMask;

% Morphological Optimization
% Smooth boundaries and reduce noise using opening/closing operations
smallStrel = strel('disk', 2);
adaxialMaskDilated = imdilate(adaxialMask, smallStrel);
abaxialMaskDilated = imdilate(abaxialMask, smallStrel);

% Ensure mutual exclusivity between masks
adaxialMask = (adaxialMaskDilated & ~abaxialMaskDilated) & finalMask;
abaxialMask = (abaxialMaskDilated & ~adaxialMaskDilated) & finalMask;

% Remove small isolated regions
adaxialMask = bwareaopen(adaxialMask, 300);
abaxialMask = bwareaopen(abaxialMask, 300);

%% 4. Visualization of Results
combinedOverlay = img;

% Highlight Adaxial Surface in Red (R channel boosted, G/B suppressed)
combinedOverlay(:,:,1) = min(combinedOverlay(:,:,1) + uint8(adaxialMask)*255, 255);
combinedOverlay(:,:,2) = combinedOverlay(:,:,2) .* uint8(~adaxialMask);
combinedOverlay(:,:,3) = combinedOverlay(:,:,3) .* uint8(~adaxialMask);

% Highlight Abaxial Surface in Blue (B channel boosted, R/G suppressed)
combinedOverlay(:,:,3) = min(combinedOverlay(:,:,3) + uint8(abaxialMask)*255, 255);
combinedOverlay(:,:,1:2) = combinedOverlay(:,:,1:2) .* uint8(~abaxialMask);

figure;
imshow(combinedOverlay); 
title('Segmentation Result: Adaxial (Red) vs. Abaxial (Blue)');

% Display Processing Time
fprintf('Processing completed in %.2f seconds.\n', toc);
